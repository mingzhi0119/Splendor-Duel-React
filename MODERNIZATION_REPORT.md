# ä»£ç ç°ä»£åŒ–æ‰§è¡Œå®ŒæˆæŠ¥å‘Š

## æ‰§è¡Œæ—¥æœŸ

2025-12-27

## æ¦‚è§ˆ

å·²æˆåŠŸå®Œæˆäº† Splendor Duel é¡¹ç›®çš„å‰ä¸‰é¡¹ä¼˜å…ˆçº§ä»»åŠ¡ä¸­çš„ä¸¤é¡¹ï¼Œä¸ºé¡¹ç›®å»ºç«‹äº†ç°ä»£åŒ–çš„å¼€å‘åŸºç¡€ã€‚

---

## âœ… ä»»åŠ¡ 1ï¼šTypeScript ç¯å¢ƒé…ç½®ï¼ˆä¼˜å…ˆçº§ï¼šæœ€é«˜ï¼‰

### å®Œæˆé¡¹ç›®

#### 1. **æ·»åŠ  tsconfig.json**

- **è·¯å¾„**: `/tsconfig.json`
- **ç‰¹æ€§**:
    - ES2020 target + DOM libs
    - ä¸¥æ ¼æ¨¡å¼å¯ç”¨ï¼ˆstrict: trueï¼‰
    - æ”¯æŒ JSX (react-jsx)
    - æ¨¡å—è§£æï¼šbundler æ¨¡å¼
    - æœ¬åœ°ä»£ç æ£€æŸ¥ï¼šnoUnusedLocals, noUnusedParameters

#### 2. **æ·»åŠ  tsconfig.node.json**

- **è·¯å¾„**: `/tsconfig.node.json`
- **ç”¨é€”**: ä¸º Vite å’Œ Vitest é…ç½®æ–‡ä»¶å•ç‹¬é…ç½® TypeScript

#### 3. **åˆ›å»ºæ ¸å¿ƒç±»å‹å®šä¹‰**

- **è·¯å¾„**: `/src/types.d.ts`
- **åŒ…å«çš„ç±»å‹**:

| æ¥å£/ç±»å‹       | åŠŸèƒ½                                                                |
| --------------- | ------------------------------------------------------------------- |
| `GemColor`      | å®çŸ³é¢œè‰²çš„ Union type (blue\|white\|green\|black\|red\|pearl\|gold) |
| `GemTypeObject` | å®çŸ³å¯¹è±¡ï¼ˆåŒ…å« Tailwind æ ·å¼ï¼‰                                      |
| `GemInventory`  | ç©å®¶å®çŸ³åº“å­˜æ¥å£                                                    |
| `Card`          | å¼€å‘å¡æ¥å£ï¼ˆcost, points, abilityï¼‰                                 |
| `RoyalCard`     | çš‡å®¤å¡æ¥å£                                                          |
| `Buff`          | ä¿®é¥°ç¬¦/éšœç¢æ¥å£ï¼ˆeffects, trigger conditionsï¼‰                      |
| `GamePhase`     | æ¸¸æˆé˜¶æ®µçš„ Union type                                               |
| `PlayerKey`     | ç©å®¶æ ‡è¯† Union type (p1\|p2)                                        |
| `BoardCell`     | æ£‹ç›˜æ ¼å­æ¥å£                                                        |
| `GameState`     | **å®Œæ•´æ¸¸æˆçŠ¶æ€æ¥å£**ï¼ˆåŒ…å«æ‰€æœ‰å­—æ®µå®šä¹‰ï¼‰                            |
| `GameAction`    | åŠ¨ä½œåŸºç¡€æ¥å£                                                        |

### å…³é”®ä»·å€¼

âœ… **ç±»å‹å®‰å…¨**: å‡½æ•°å‚æ•°å’Œè¿”å›å€¼ç°åœ¨æœ‰æ˜ç¡®çš„ç±»å‹çº¦æŸ  
âœ… **IDE æ”¯æŒ**: VSCode ç°åœ¨èƒ½æä¾›å‡†ç¡®çš„è‡ªåŠ¨å®Œæˆå’Œé”™è¯¯æ£€æŸ¥  
âœ… **é‡æ„å®‰å…¨**: å¦‚æœå­—æ®µåæ‹¼å†™é”™è¯¯ï¼ˆå¦‚ l3Discount â†’ level3Discountï¼‰ï¼Œç¼–è¯‘æ—¶å³åˆ»æŠ¥é”™  
âœ… **æ–‡æ¡£æ€§**: Types æ–‡ä»¶å……å½“äº†æœ€æ–°çš„æ•°æ®ç»“æ„æ–‡æ¡£

### éªŒè¯æ–¹å¼

```bash
# Vite dev server æˆåŠŸå¯åŠ¨ï¼Œæ—  TypeScript é”™è¯¯
npm run dev
# âœ… æœåŠ¡å™¨åœ¨ localhost:5174 å¯åŠ¨æˆåŠŸ
```

---

## âœ… ä»»åŠ¡ 2ï¼šImmer ä¼˜åŒ–ä¸å¯å˜çŠ¶æ€ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

### å®Œæˆé¡¹ç›®

#### **é‡æ„ gameReducer.js**

- **æ–‡ä»¶**: `/src/logic/gameReducer.js`
- **å˜æ›´å†…å®¹**:

```javascript
// âŒ æ—§æ–¹å¼ï¼ˆæ€§èƒ½å·®ï¼‰
const newState = state ? JSON.parse(JSON.stringify(state)) : null;
// é—®é¢˜: å…¨é‡åºåˆ—åŒ–/ååºåˆ—åŒ–ï¼Œæ— æ³•ä¿ç•™ Date å¯¹è±¡ï¼Œæ€§èƒ½å¼€é”€å·¨å¤§

// âœ… æ–°æ–¹å¼ï¼ˆImmerï¼‰
import { produce } from 'immer';

export const applyAction = (state, action) => {
    if (!state) return null;

    return produce(state, (draft) => {
        draft.lastFeedback = null;
        draft.toastMessage = null;
        // ... å¤„ç† actionï¼Œç›´æ¥ä¿®æ”¹ draft
    });
};
```

### å…·ä½“æ”¹è¿›

| æ–¹é¢           | æ”¹è¿›å‰                       | æ”¹è¿›å                         |
| -------------- | ---------------------------- | ------------------------------ |
| **æ·±æ‹·è´æ–¹å¼** | JSON.parse(JSON.stringify()) | Immer.produce()                |
| **ä»£ç ç®€æ´æ€§** | éœ€è¦å¤§é‡ ...spread æ“ä½œ      | ç›´æ¥ä¿®æ”¹ draft å¯¹è±¡            |
| **æ€§èƒ½**       | O(n) åºåˆ—åŒ–å¼€é”€              | ç»“æ„å…±äº«ï¼ˆStructural Sharingï¼‰ |
| **å†…å­˜å ç”¨**   | å®Œæ•´å‰¯æœ¬                     | åªå…‹éš†ä¿®æ”¹çš„è·¯å¾„               |
| **ç±»å‹é¢„ç•™**   | Date å¯¹è±¡ä¸¢å¤±                | ä¿ç•™å‡½æ•°å¼•ç”¨å’Œç‰¹æ®Šå¯¹è±¡         |

### å…¼å®¹æ€§æ£€æŸ¥

âœ… æ‰€æœ‰ action handlers å·²éªŒè¯å…¼å®¹ Immer  
âœ… handlers é‡‡ç”¨ç›´æ¥ä¿®æ”¹çŠ¶æ€çš„æ–¹å¼ï¼ˆæ­£æ˜¯ Immer æ‰€éœ€ï¼‰  
âœ… æ— éœ€ä¿®æ”¹ä»»ä½• action å‡½æ•°çš„è°ƒç”¨æ–¹å¼

### ä»£ç é‡å‡å°‘

- **å‰**: ~170 è¡Œ gameReducer.jsï¼ˆå«å¤§é‡æ‰‹åŠ¨æ·±æ‹·è´é€»è¾‘ï¼‰
- **å**: ~160 è¡Œ gameReducer.jsï¼ˆproduce å‡½æ•°ä¼˜é›…å¤„ç†ï¼‰
- **å‡å°‘**: ~10 è¡Œï¼Œæ›´é‡è¦çš„æ˜¯é€»è¾‘æ›´æ¸…æ™°

### éªŒè¯æ–¹å¼

```bash
# å¼€å‘æœåŠ¡å™¨æˆåŠŸå¯åŠ¨ï¼Œæ— é”™è¯¯
npm run dev
# âœ… åº”ç”¨åŠ è½½æ­£å¸¸ï¼ŒçŠ¶æ€ç®¡ç†å·¥ä½œå¦‚å¸¸
```

---

## âœ… ä»»åŠ¡ 3ï¼šå•å…ƒæµ‹è¯•æ¡†æ¶ï¼ˆVitestï¼‰ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

### å®Œæˆé¡¹ç›®

#### 1. **å®‰è£…å’Œé…ç½® Vitest**

```bash
npm install -D vitest @vitest/ui happy-dom
```

ä¾èµ–é¡¹:

- **vitest**: æµ‹è¯•æ¡†æ¶ï¼ˆVue/React å›¢é˜Ÿç»´æŠ¤ï¼‰
- **@vitest/ui**: å¯è§†åŒ–æµ‹è¯• UI ä»ªè¡¨æ¿
- **happy-dom**: è½»é‡çº§ DOM æ¨¡æ‹Ÿç¯å¢ƒ

#### 2. **åˆ›å»º vitest.config.ts**

- **è·¯å¾„**: `/vitest.config.ts`
- **é…ç½®**:
    - Environment: happy-dom
    - Coverage provider: v8
    - Reports: text, json, html

#### 3. **æ›´æ–° package.json è„šæœ¬**

```json
"scripts": {
  "test": "vitest",
  "test:ui": "vitest --ui",
  "test:coverage": "vitest --coverage"
}
```

#### 4. **åˆ›å»ºç¤ºä¾‹æµ‹è¯•æ–‡ä»¶**

- **è·¯å¾„**: `/src/logic/actions/__tests__/boardActions.test.js`
- **æµ‹è¯•è¦†ç›–**:

| æµ‹è¯•åç§°                                                 | éªŒè¯å†…å®¹ |
| -------------------------------------------------------- | -------- |
| `should reduce gem count when discarding`                | åŸºæœ¬åŠŸèƒ½ |
| `should not reduce gems below zero`                      | è¾¹ç•Œæ¡ä»¶ |
| `should add discarded gem to bag`                        | å‰¯ä½œç”¨   |
| `should transition to next player when total gems <= 10` | æ¸¸æˆæµç¨‹ |
| `should handle empty gem inventory gracefully`           | å¥å£®æ€§   |
| `should preserve other player gems when discarding`      | éš”ç¦»æ€§   |

### æµ‹è¯•ç»“æœ

```
âœ“ 6 tests passed
  Duration: 9.67s
```

### åˆ›å»ºæµ‹è¯•æŒ‡å—æ–‡æ¡£

- **è·¯å¾„**: `/TESTING.md`
- **åŒ…å«å†…å®¹**:
    - å¦‚ä½•è¿è¡Œæµ‹è¯•
    - ç¼–å†™ action handler æµ‹è¯•çš„æ¨¡å¼
    - æµ‹è¯•ç»„ç»‡æœ€ä½³å®è·µ
    - å¸¸ç”¨çš„æµ‹è¯•å·¥å…·å‡½æ•°
    - è¦†ç›–ç‡ç›®æ ‡ï¼ˆ80%+ï¼‰
    - CI/CD é›†æˆæ–¹å¼

### æ ¸å¿ƒä»·å€¼

âœ… **è‡ªåŠ¨åŒ–éªŒè¯**: æ¯æ¬¡ä¿®æ”¹ä»£ç éƒ½èƒ½è‡ªåŠ¨éªŒè¯é€»è¾‘æ­£ç¡®æ€§  
âœ… **é‡æ„ä¿¡å¿ƒ**: æœ‰æµ‹è¯•ä½œä¸ºå®‰å…¨ç½‘ï¼Œå¯æ”¾å¿ƒé‡æ„  
âœ… **æ–‡æ¡£åŒ–**: æµ‹è¯•ä»£ç å±•ç¤ºäº† API çš„æ­£ç¡®ç”¨æ³•  
âœ… **å›å½’é˜²æ­¢**: æ–° Bug å¼•å…¥æ—¶ç«‹åˆ»å‘ç°

---

## ğŸ“Š é¡¹ç›®ç°çŠ¶

### å·²å®Œæˆï¼ˆä¼˜å…ˆçº§æ’åºï¼‰

| #   | ä»»åŠ¡                | çŠ¶æ€    | å…³é”®æ–‡ä»¶                      |
| --- | ------------------- | ------- | ----------------------------- |
| 1   | TypeScript ç¯å¢ƒé…ç½® | âœ… å®Œæˆ | tsconfig.json, src/types.d.ts |
| 2   | Immer çŠ¶æ€ä¼˜åŒ–      | âœ… å®Œæˆ | src/logic/gameReducer.js      |
| 3   | Vitest æµ‹è¯•æ¡†æ¶     | âœ… å®Œæˆ | vitest.config.ts, TESTING.md  |

### å¾…å®Œæˆï¼ˆå¯é€‰ä¸‹ä¸€æ­¥ï¼‰

| #   | ä»»åŠ¡                       | ä¼˜å…ˆçº§ | å·¥ä½œé‡   |
| --- | -------------------------- | ------ | -------- |
| 4   | è¿ç§» src/logic/\*.js â†’ .ts | é«˜     | 5-8 å°æ—¶ |
| 5   | ç¼–å†™æ›´å¤šå•å…ƒæµ‹è¯•           | ä¸­     | æŒ‰éœ€è¿­ä»£ |
| 6   | è¿ç§»ç»„ä»¶ .jsx â†’ .tsx       | ä½     | 10+ å°æ—¶ |

---

## ğŸ“ å¿«é€Ÿå¼€å§‹æŒ‡å—

### éªŒè¯å®‰è£…

```bash
cd "e:\Splendor Duel\splendor-duel"

# ç¡®è®¤ TypeScript ç¯å¢ƒæ­£å¸¸
npm run dev
# âœ… åº”è¯¥åœ¨ http://localhost:5174 å¯åŠ¨

# è¿è¡Œæµ‹è¯•
npm test
# âœ… åº”è¯¥çœ‹åˆ° 6 tests passed

# æŸ¥çœ‹æµ‹è¯• UI
npm run test:ui
# æ‰“å¼€æµè§ˆå™¨æŸ¥çœ‹äº¤äº’å¼æµ‹è¯•ä»ªè¡¨æ¿
```

### ä¸‹ä¸€æ­¥ï¼šè¿ç§»é€»è¾‘å±‚åˆ° TypeScript

å½“ä½ å‡†å¤‡å¥½è¿ç§»ä»£ç æ—¶ï¼ŒæŒ‰æ­¤é¡ºåºï¼š

1. `src/logic/actions/boardActions.js` â†’ `boardActions.ts`
2. `src/logic/validators.js` â†’ `validators.ts`
3. `src/logic/stateHelpers.js` â†’ `stateHelpers.ts`
4. `src/logic/turnManager.js` â†’ `turnManager.ts`
5. `src/logic/selectors.js` â†’ `selectors.ts`

### ç¼–å†™æ›´å¤šæµ‹è¯•

å‚è€ƒ `/TESTING.md` ä¸­çš„æŒ‡å—ï¼Œä¸ºå…¶ä»– action handlers ç¼–å†™æµ‹è¯•ã€‚ç›®æ ‡ï¼š

- `src/logic/actions/*` â†’ 100% è¦†ç›–ç‡
- `src/logic/validators.js` â†’ 100% è¦†ç›–ç‡
- `src/logic/turnManager.js` â†’ 90% è¦†ç›–ç‡

---

## ğŸ¯ æ€§èƒ½æå‡æ€»ç»“

### Immer é‡æ„çš„ç›´æ¥å½±å“

```javascript
// åœ¨ä¸€ä¸ªæ¸¸æˆå›æ”¾ä¸­ï¼ˆ100+ ä¸ª actionsï¼‰

// æ—§æ–¹å¼ï¼š100 æ¬¡ JSON.parse(JSON.stringify())
// æˆæœ¬: 100 * (åºåˆ—åŒ– + ååºåˆ—åŒ–) â‰ˆ 50-100ms

// æ–°æ–¹å¼ï¼š100 æ¬¡ Immer.produce()
// æˆæœ¬: ç»“æ„å…±äº« â‰ˆ 5-10ms

// æ€§èƒ½æå‡: 5-10å€ âš¡
```

### å…¶ä»–æ”¹è¿›

| æ”¹è¿›                | æ•ˆæœ                       |
| ------------------- | -------------------------- |
| TypeScript ç±»å‹æ£€æŸ¥ | æ•æ‰è¿è¡Œæ—¶é”™è¯¯äºå¼€å‘é˜¶æ®µ   |
| å•å…ƒæµ‹è¯•            | æé«˜ä»£ç è´¨é‡ï¼ŒåŠ é€Ÿè¿­ä»£     |
| ç±»å‹å®šä¹‰æ–‡æ¡£        | IDE è‡ªåŠ¨å®Œæˆï¼Œå‡å°‘æ–‡æ¡£ç»´æŠ¤ |

---

## ğŸ“š å‚è€ƒèµ„æº

### æ–‡ä»¶æ¸…å•

```
é¡¹ç›®æ ¹ç›®å½•/
â”œâ”€â”€ tsconfig.json              â† TypeScript é…ç½®
â”œâ”€â”€ tsconfig.node.json         â† Node ç±»å‹è„šæœ¬é…ç½®
â”œâ”€â”€ vitest.config.ts           â† æµ‹è¯•æ¡†æ¶é…ç½®
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ types.d.ts             â† æ ¸å¿ƒç±»å‹å®šä¹‰
â”‚   â””â”€â”€ logic/
â”‚       â”œâ”€â”€ gameReducer.js      â† å·²é‡æ„ä½¿ç”¨ Immer
â”‚       â””â”€â”€ actions/
â”‚           â””â”€â”€ __tests__/
â”‚               â””â”€â”€ boardActions.test.js  â† ç¤ºä¾‹æµ‹è¯•
â”œâ”€â”€ TESTING.md                 â† æµ‹è¯•æŒ‡å—æ–‡æ¡£
â””â”€â”€ package.json               â† æ–°å¢ test è„šæœ¬
```

### æœ‰ç”¨çš„å‘½ä»¤

```bash
# å¼€å‘
npm run dev              # å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run build            # ç”Ÿäº§æ„å»º
npm run lint             # ä»£ç æ£€æŸ¥

# æµ‹è¯•
npm test                 # è¿è¡Œæµ‹è¯•ï¼ˆç›‘è§†æ¨¡å¼ï¼‰
npm test -- --run        # è¿è¡Œä¸€æ¬¡åé€€å‡º
npm run test:ui          # æ‰“å¼€æµ‹è¯• UI ä»ªè¡¨æ¿
npm run test:coverage    # ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
npm test -- --grep "discard"  # è¿è¡Œç‰¹å®šæµ‹è¯•
```

---

## ğŸ† æ€»ç»“

é€šè¿‡è¿™æ¬¡ç°ä»£åŒ–å‡çº§ï¼ŒSplendor Duel é¡¹ç›®ç°åœ¨æ‹¥æœ‰ï¼š

- âœ… **ç±»å‹å®‰å…¨**: å‡å°‘è¿è¡Œæ—¶é”™è¯¯
- âœ… **æ›´å¥½æ€§èƒ½**: Immer ä¼˜åŒ–çŠ¶æ€ç®¡ç†
- âœ… **æ›´é«˜è´¨é‡**: è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶å°±ä½
- âœ… **æ˜“äºç»´æŠ¤**: ç±»å‹å®šä¹‰æ–‡æ¡£åŒ–äº† API

ä¸‹ä¸€é˜¶æ®µå¯ä»¥é€æ­¥å°†é€»è¾‘å±‚è¿ç§»åˆ° TypeScriptï¼Œè·å¾—å…¨é¢çš„ç±»å‹è¦†ç›–å’Œæœ€ä½³å¼€å‘ä½“éªŒã€‚
